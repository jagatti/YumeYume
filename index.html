<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>YumeYume Rhythm Game</title>
<style>
  html, body {
    margin: 0; padding: 0;
    width: 100%; height: 100%;
    background: #0f172a; overflow: hidden;
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
  }
  #gameCanvas {
    display: block; margin: auto;
    background: #1e293b; border: 2px solid #334155; border-radius: 10px;
    touch-action: none;
  }
  #startBtn {
    position: absolute; top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    padding: 1em 2em; font-size: 1.4rem;
    background: #3b82f6; color: #fff; border: none; border-radius: 10px;
    cursor: pointer; z-index: 10;
  }
</style>
</head>
<body>
  <button id="startBtn">ゲームスタート</button>
  <audio id="bgm" src="YumeYume.mp3" preload="auto"></audio>
  <canvas id="gameCanvas" width="980" height="640"></canvas>

<script>
'use strict';

const cvs = document.getElementById('gameCanvas');
const ctx = cvs.getContext('2d');
const bgm = document.getElementById('bgm');
const startBtn = document.getElementById('startBtn');

let gameState = 'waiting';
let frame = 0;
let countdown = 3;
let countdownTimer = 0;

const bpm = 159;
const beatInterval = 60 / bpm;
let nextBeatTime = 0;

const TARGET_Y = 500;
const LEFT_X = 330;
const RIGHT_X = 650;
const NOTE_R = 20;
let notes = [];
let totalNotesSpawned = 0;
const MAX_NOTES = 70;

let score = 0;
let combo = 0;

const SP_MAX = 6000;
let spValue = 0;
let spUseCount = 0;

let skillActivationCount = 0;
let appealBoostNotes = 0;

let skillHistory = [];
let popups = [];
let progressDisplay = 0;
let gameEnded = false;

function clamp(v, lo, hi){ return Math.max(lo, Math.min(hi, v)); }

function spawnNote(){
  const x = Math.random() < 0.5 ? LEFT_X : RIGHT_X;
  const speed = (TARGET_Y + 60) / (60 * 1.2);
  notes.push({ x, y: -60, speed });
}

function findBestNote(){
  let best = null, bestDist = Infinity, bestIdx = -1;
  for(let i=0;i<notes.length;i++){
    const n = notes[i];
    const d = Math.abs(n.y - TARGET_Y);
    if(d < bestDist){ bestDist = d; best = n; bestIdx = i; }
  }
  return {best, bestDist, bestIdx};
}

function addPopup(text, x, y, type='label'){
  popups.push({text, x, y, life: 60, type});
}

function pushHistory(text){
  skillHistory.unshift({text, life: 180});
  if(skillHistory.length > 5) skillHistory.pop();
}

function judgeAndScore(dist){
  let label = 'MISS';
  let base = 0;

  if(dist <= 6){ label = 'WONDERFUL'; base = 4000; }
  else if(dist <= 10){ label = 'GREAT'; base = 3000; }
  else if(dist <= 14){ label = 'NICE'; base = 2000; }
  else if(dist <= 18){ label = 'BAD'; base = 1000; }

  if(appealBoostNotes > 0){
    base = Math.ceil(base * 1.12);
    appealBoostNotes--;
  }

  if(label === 'MISS'){
    combo = 0;
    addPopup('MISS', cvs.width/2, TARGET_Y - 220, 'label');
    return {hit:false, label, base};
  }

  combo++;
  score += base;
  addPopup(label, cvs.width/2, TARGET_Y - 220, 'label');
  addPopup('+' + base, cvs.width/2, TARGET_Y - 190, 'score');
  return {hit:true, label, base};
}

function isInSPSemicircle(mx, my){
  const cx = cvs.width/2, cy = cvs.height-30, r = 70;
  const dx = mx - cx, dy = my - cy;
  const d = Math.hypot(dx,dy);
  return (d <= r) && (my <= cy);
}

cvs.addEventListener('click', (e)=>{
  if(gameState !== 'playing') return;

  const rect = cvs.getBoundingClientRect();
  const mx = (e.clientX - rect.left) * (cvs.width  / rect.width);
  const my = (e.clientY - rect.top)  * (cvs.height / rect.height);

  if(spValue >= SP_MAX && isInSPSemicircle(mx, my)){
    spUseCount++;
    score += 25000;
    spValue = 0;
    for(let i=0;i<6;i++){
      if(Math.random() < 0.3){
        spValue = Math.min(SP_MAX, spValue + 600);
        pushHistory('[SPゲージ獲得]');
      }
    }
    return;
  }

  const {best, bestDist, bestIdx} = findBestNote();
  if(!best){
    combo = 0;
    return;
  }

  const result = judgeAndScore(bestDist);
  if(result.hit){
    notes.splice(bestIdx, 1);
    spValue = clamp(spValue + 300, 0, SP_MAX);
    if(Math.random() < 0.1){
      skillActivationCount++;
      appealBoostNotes += 5;
      pushHistory('[特技発動：アピール強化]');
    }
  }
});

function update(){
  frame++;

  if(gameState === 'countdown'){
    countdownTimer += 1/60;
    if(countdownTimer >= 1){
      countdown--;
      countdownTimer = 0;
      if(countdown <= 0){
        gameState = 'playing';
        bgm.play();
        nextBeatTime = bgm.currentTime + beatInterval;
      }
    }
  }

  if(gameState === 'playing'){
    if(bgm.currentTime >= nextBeatTime && totalNotesSpawned < MAX_NOTES){
      spawnNote();
      totalNotesSpawned++;
      nextBeatTime += beatInterval;
    }

    for(const n of notes){
      n.y += n.speed;
    }

    notes = notes.filter(n => n.y < cvs.height + 60);

    if(totalNotesSpawned >= MAX_NOTES && notes.length === 0){
      gameState = 'result';
      gameEnded = true;
    }
  }

  for(const p of popups){
    p.life--;
  }
  popups = popups.filter(p => p.life > 0);

  for(const h of skillHistory){
    h.life--;
  }
  skillHistory = skillHistory.filter(h => h.life > 0);

  draw();
  requestAnimationFrame(update);
}

startBtn.addEventListener('click', ()=>{
  if(gameState === 'waiting'){
    gameState = 'countdown';
    startBtn.style.display = 'none';
    update();
  }
});

function draw(){
  ctx.clearRect(0, 0, cvs.width, cvs.height);

  ctx.fillStyle = '#94a3b8';
  ctx.beginPath();
  ctx.arc(cvs.width/2, TARGET_Y, NOTE_R, 0, Math.PI*2);
  ctx.fill();

  for(const n of notes){
    ctx.fillStyle = '#f87171';
    ctx.beginPath();
    ctx.arc(n.x, n.y, NOTE_R, 0, Math.PI*2);
    ctx.fill();
  }

  for(const p of popups){
    ctx.font = 'bold 24px sans-serif';
    ctx.fillStyle = p.type === 'label' ? '#facc15' : '#38bdf8';
    ctx.fillText(p.text, p.x, p.y);
  }

  ctx.fillStyle = '#22c55e';
  ctx.fillRect(20, cvs.height - 20, cvs.width - 40, 10);
  const progress = clamp((totalNotesSpawned / MAX_NOTES), 0, 1);
  ctx.fillStyle = '#4ade80';
  ctx.fillRect(20, cvs.height - 20, (cvs.width - 40) * progress, 10);

  ctx.fillStyle = '#fff';
  ctx.font = 'bold 20px sans-serif';
  ctx.fillText('Score: ' + score, 20, 30);
  ctx.fillText('Combo: ' + combo, 20, 60);
  ctx.fillText('SP: ' + spValue + '/' + SP_MAX, 20, 90);

  ctx.beginPath();
  ctx.arc(cvs.width/2, cvs.height - 30, 70, 0, Math.PI, true);
  ctx.strokeStyle = '#3b82f6';
  ctx.lineWidth = 4;
  ctx.stroke();

  let y = 120;
  for(const h of skillHistory){
    ctx.fillStyle = '#f472b6';
    ctx.fillText(h.text, 20, y);
    y += 30;
  }
}
</script>
</body>
</html>
